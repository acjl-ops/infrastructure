#!/usr/bin/env bash

self_basename="$(basename "$0")"

if [ "$self_basename" = "ssh-vnc-machine" ]; then
  echo "Please execute a linked binary instead!"
  exit 1
fi

machine_name="$(echo "$self_basename" | sed 's/^ssh-vnc-\(.*\)/\1/')"

ssh "$machine_name" "systemctl start --user x0vncserver"
ssh -L 127.0.0.1:5999:127.0.0.1:5900 -N "$machine_name" &
ssh_pid=$!
sleep 1 # wait for server initialization
vncviewer 127.0.0.1:5999
kill -9 "$ssh_pid"
ssh "$machine_name" "systemctl stop --user x0vncserver"
