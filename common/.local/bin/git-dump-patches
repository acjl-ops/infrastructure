#!/usr/bin/env bash

if [[ -z "${1+x}" ]]; then
  DEFAULT_BRANCH="$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/@@' || echo "")"
  if [[ "$DEFAULT_BRANCH" == "" ]]; then
    if git branch | grep "^[+*]\?\s\+main$" >/dev/null 2>&1; then
      DEFAULT_BRANCH="main"
    else
      DEFAULT_BRANCH="master"
    fi
  fi
else
  DEFAULT_BRANCH="$1"
fi

count_commits=$(( $(git rev-list --count "$DEFAULT_BRANCH..HEAD") - 1))

for c in $(seq 0 "$count_commits"); do
  c_rev="$((count_commits - c))"
  git show --patch -U99999999 "HEAD~$c" > "$c_rev - $(git rev-parse --short "HEAD~$c") - $(git rev-list --format=%B --max-count=1 "HEAD~$c" | tail +2 | head -n1 | tr '/' '_').git-local.patch"
done
